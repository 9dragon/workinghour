# 项目工时统计WEB软件数据库详细设计

## 一、基本信息

|字段名称|内容|
|---|---|
|文档版本|V1.1.0|
|文档作者|全栈软件开发工程师|
|创建日期|2026-01-15|
|最后更新|2026-01-17|
|关联文档|《架构设计说明书 V1.2.0》《需求规格书 V1.1.0》|
|数据库类型|SQLite 3|
|字符集|UTF-8|

## 二、数据库概述

### 2.1 设计原则

- **极简优先**：仅存储必要字段，避免冗余
- **性能优先**：为高频查询字段创建索引
- **可扩展性**：预留扩展字段，便于未来功能迭代
- **数据完整性**：通过外键、约束保证数据一致性

### 2.2 表清单

|表名|用途|记录数预估|重要级别|
|---|---|---|---|
|work_hour_data|工时数据主表|10万+|核心|
|import_records|导入批次记录表|1千+|重要|
|check_records|核对批次记录表|1千+|重要|
|sys_users|系统用户表|50+|核心|
|sys_config|系统配置表|20+|辅助|

---

## 三、核心数据表设计

### 3.1 工时数据表（work_hour_data）

#### 3.1.1 表结构

存储从钉钉OA审批导入的工时数据，是系统的核心数据表。

```sql
CREATE TABLE work_hour_data (
    -- 主键
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- 钉钉原始数据字段（对应需求15个核心字段）
    serial_no TEXT NOT NULL DEFAULT '',                -- 序号
    user_name TEXT NOT NULL,                           -- 姓名
    start_time DATE NOT NULL,                          -- 开始日期（yyyy-MM-dd）
    end_time DATE NOT NULL,                            -- 结束日期（yyyy-MM-dd）
    project_manager TEXT,                              -- 项目经理
    project_name TEXT NOT NULL,                        -- 项目名称
    work_hours REAL NOT NULL,                          -- 工作时长
    overtime_hours REAL DEFAULT 0,                     -- 加班时长
    work_content TEXT,                                 -- 工作内容
    create_time DATETIME,                              -- OA创建时间
    current_leader TEXT,                               -- 当前负责人
    approval_result TEXT NOT NULL DEFAULT '通过',      -- 审批结果
    approval_status TEXT NOT NULL DEFAULT '已完成',    -- 审批状态
    update_time DATETIME,                              -- OA更新时间
    dept_name TEXT NOT NULL,                           -- 部门名称

    -- 系统扩展字段
    import_batch_no TEXT NOT NULL,                     -- 导入批次号
    import_time DATETIME NOT NULL DEFAULT (datetime('now', 'localtime')),  -- 导入时间
    created_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime')),  -- 记录创建时间
    updated_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime'))   -- 记录更新时间

    -- 表级约束（SQLite不支持CHECK的复杂约束，在应用层实现）
);

-- 创建索引
CREATE INDEX idx_work_hour_data_start_time ON work_hour_data(start_time);
CREATE INDEX idx_work_hour_data_user_name ON work_hour_data(user_name);
CREATE INDEX idx_work_hour_data_dept_name ON work_hour_data(dept_name);
CREATE INDEX idx_work_hour_data_project_name ON work_hour_data(project_name);
CREATE INDEX idx_work_hour_data_import_batch_no ON work_hour_data(import_batch_no);
CREATE INDEX idx_work_hour_data_composite ON work_hour_data(user_name, start_time, project_name);

-- 添加表注释（SQLite使用注释）
-- work_hour_data: 工时数据主表，存储从钉钉OA审批导入的所有有效工时记录
```

#### 3.1.2 字段详细说明

|字段名|类型|长度|非空|默认值|索引|说明|
|---|---|---|---|---|---|---|
|id|INTEGER|-|是|自增|PK|主键|
|serial_no|TEXT|50|否|''|-|钉钉OA审批记录序号，业务唯一标识的一部分|
|user_name|TEXT|50|是|-|✅|提交OA审批的人员姓名|
|start_time|DATE|-|是|-|✅|工作开始日期，格式yyyy-MM-dd，按天统计工时|
|end_time|DATE|-|是|-|-|工作结束日期，格式yyyy-MM-dd，必须≥开始日期|
|project_manager|TEXT|50|否|-|-|对应项目的项目经理姓名|
|project_name|TEXT|100|是|✅|✅|工作所属的项目名称，核心查询条件|
|work_hours|REAL|-|是|-|-|实际工作时长，单位：小时，支持1位小数，≥0|
|overtime_hours|REAL|-|否|0|-|加班时长，单位：小时，支持1位小数，≥0且≤work_hours|
|work_content|TEXT|500|否|-|-|具体工作内容描述|
|create_time|DATETIME|-|否|-|-|OA审批记录的创建时间|
|current_leader|TEXT|50|否|-|-|OA审批当前处理负责人|
|approval_result|TEXT|10|是|'通过'|-|OA审批结果，系统仅存储"通过"的数据|
|approval_status|TEXT|10|是|'已完成'|-|OA审批状态，系统仅存储"已完成"的数据|
|update_time|DATETIME|-|否|-|-|OA审批记录的最后更新时间|
|dept_name|TEXT|50|是|✅|✅|提交OA审批人员所属部门，核心查询条件|
|import_batch_no|TEXT|50|是|-|✅|导入批次号，关联导入记录表，格式：IMP_YYYYMMDDHHMMSS_XXXX|
|import_time|DATETIME|-|是|now|✅|数据导入系统的时间|
|created_at|DATETIME|-|是|now|-|记录创建时间（技术字段）|
|updated_at|DATETIME|-|是|now|-|记录更新时间（技术字段）|

#### 3.1.3 业务唯一性约束

**组合唯一标识**：`serial_no + user_name + start_time + project_name`

由于SQLite不直接支持多列唯一约束（需通过UNIQUE索引实现），在应用层进行唯一性校验：

```python
# 伪代码示例
def check_duplicate(data):
    exists = db.query(
        "SELECT COUNT(*) FROM work_hour_data WHERE serial_no=? AND user_name=? AND start_time=? AND project_name=?",
        (data.serial_no, data.user_name, data.start_time, data.project_name)
    )
    return exists > 0
```

#### 3.1.4 数据校验规则（应用层实现）

```python
# 使用pydantic进行数据校验
from pydantic import BaseModel, Field, validator
from datetime import datetime

class WorkHourDataModel(BaseModel):
    serial_no: str = Field(default='', max_length=50)
    user_name: str = Field(..., min_length=1, max_length=50)
    start_time: datetime
    end_time: datetime
    project_manager: str = Field(default='', max_length=50)
    project_name: str = Field(..., min_length=1, max_length=100)
    work_hours: float = Field(..., ge=0, le=168)  # 一周最大168小时
    overtime_hours: float = Field(default=0, ge=0, le=168)  # 一周最大168小时
    work_content: str = Field(default='', max_length=500)
    create_time: datetime = None
    current_leader: str = Field(default='', max_length=50)
    approval_result: str = Field(default='通过', regex='^(通过|审批通过)$')
    approval_status: str = Field(default='已完成', regex='^(已完成|已结束)$')
    update_time: datetime = None
    dept_name: str = Field(..., min_length=1, max_length=50)

    @validator('end_time')
    def validate_end_time(cls, v, values):
        if 'start_time' in values and v < values['start_time']:
            raise ValueError('结束时间不能早于开始时间')
        return v

    @validator('overtime_hours')
    def validate_overtime_hours(cls, v, values):
        if 'work_hours' in values and v > values['work_hours']:
            raise ValueError('加班时长不能大于工作时长')
        return v
```

---

### 3.2 导入记录表（import_records）

#### 3.2.1 表结构

记录每次Excel导入操作的批次信息和执行结果。

```sql
CREATE TABLE import_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    batch_no TEXT NOT NULL UNIQUE,                     -- 批次号，唯一
    file_name TEXT NOT NULL,                           -- 原始文件名
    file_size INTEGER NOT NULL DEFAULT 0,              -- 文件大小（字节）
    total_rows INTEGER NOT NULL DEFAULT 0,             -- 文件总行数
    success_rows INTEGER NOT NULL DEFAULT 0,           -- 成功导入行数
    repeat_rows INTEGER NOT NULL DEFAULT 0,            -- 重复数据行数
    invalid_rows INTEGER NOT NULL DEFAULT 0,           -- 无效数据行数
    duplicate_strategy TEXT NOT NULL DEFAULT 'skip',   -- 重复数据处理策略
    import_user TEXT NOT NULL,                         -- 导入操作用户
    import_time DATETIME NOT NULL DEFAULT (datetime('now', 'localtime')),
    report_path TEXT,                                  -- 导入报告文件路径
    error_details TEXT,                                -- 错误详情（JSON格式）
    repeat_details TEXT,                               -- 重复数据详情（JSON格式）
    created_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime'))
);

CREATE INDEX idx_import_records_batch_no ON import_records(batch_no);
CREATE INDEX idx_import_records_import_time ON import_records(import_time);
```

#### 3.2.2 字段详细说明

|字段名|类型|非空|默认值|索引|说明|
|---|---|---|---|---|---|
|id|INTEGER|是|自增|PK|主键|
|batch_no|TEXT|是|-|UK|导入批次号，格式：IMP_YYYYMMDDHHMMSS_XXXX，全局唯一|
|file_name|TEXT|是|-|-|用户上传的原始Excel文件名|
|file_size|INTEGER|是|0|-|文件大小，单位：字节|
|total_rows|INTEGER|是|0|-|Excel文件中的数据总行数（不含表头）|
|success_rows|INTEGER|是|0|-|成功导入的有效数据行数|
|repeat_rows|INTEGER|是|0|-|重复数据行数（根据策略跳过或覆盖）|
|invalid_rows|INTEGER|是|0|-|无效数据行数（格式错误、状态不符等）|
|duplicate_strategy|TEXT|是|'skip'|-|重复数据处理策略：skip（跳过）/ cover（覆盖）|
|import_user|TEXT|是|-|✅|执行导入操作的用户名|
|import_time|DATETIME|是|now|✅|导入操作时间|
|report_path|TEXT|否|-|-|导入报告Excel文件的存储路径（相对路径）|
|error_details|TEXT|否|-|-|错误详情，JSON格式数组，存储所有错误记录|
|repeat_details|TEXT|否|-|-|重复数据详情，JSON格式数组，存储所有重复数据记录|
|created_at|DATETIME|是|now|-|记录创建时间|

#### 3.2.3 error_details JSON结构说明

**数据格式：**

```json
[
  {"row": 5, "field": "开始时间", "error": "时间格式错误"},
  {"row": 12, "field": "项目交付-工作时长", "error": "工作时长超过168小时（一周最大时长）"},
  {"row": 18, "field": "审批结果", "error": "审批结果为'--'，仅支持'通过'或'审批通过'"},
  {"row": 25, "field": "项目交付-项目名称", "error": "项目交付-项目名称字段为空"}
]
```

**字段说明：**

- **数据类型**：TEXT字段，存储JSON数组字符串
- **数组元素**：每个元素代表一条错误记录，包含三个字段
  - `row`（number）：Excel文件中的行号（包含表头，从2开始）
  - `field`（string）：出错的字段名称
  - `error`（string）：详细的错误原因描述
- **存储限制**：支持存储无限制数量的错误记录（不限制100条）
- **序列化方法**：使用`json.dumps(errors, ensure_ascii=False)`确保中文正确存储
- **解析方法**：后端优先使用`json.loads()`解析，失败则使用`ast.literal_eval()`兼容旧格式
- **用途**：
  - 记录所有导入失败数据的详细错误信息
  - 方便用户查看和核对错误数据
  - 支持按Excel行号定位和修改错误
  - 历史记录永久保存，方便追溯

**常见错误类型：**

|错误类型|示例字段|错误描述|
|---|---|---|
|字段为空|项目交付-项目名称|"{字段名}字段为空"|
|格式错误|开始时间、项目交付-工作时长|"时间格式错误"、"工作时长格式错误"|
|取值异常|审批结果、审批状态|"审批结果为'xxx'，仅支持'通过'或'审批通过'"|
|范围超限|项目交付-工作时长|"工作时长超过168小时（一周最大时长）"|
|逻辑错误|结束时间|"结束时间早于开始时间"|

#### 3.2.4 repeat_details JSON结构说明

**数据格式：**

```json
[
  {"row": 7, "field": "数据重复", "error": "序号A001、姓名张三、时间2026-01-15 09:00:00、项目智慧城市的工时数据已存在", "existing_batch": "IMP_20260110100000_1234"},
  {"row": 15, "field": "数据重复", "error": "序号A002、姓名李四、时间2026-01-15 14:00:00、项目管理系统的工时数据已存在", "existing_batch": "IMP_20260112150000_5678"},
  {"row": 23, "field": "数据重复", "error": "序号A003、姓名王五、时间2026-01-16 10:00:00、项目数据分析平台的工时数据已存在", "existing_batch": "IMP_20260114120000_9012"}
]
```

**字段说明：**

- **数据类型**：TEXT字段，存储JSON数组字符串
- **数组元素**：每个元素代表一条重复数据记录，包含四个字段
  - `row`（number）：Excel文件中的行号（包含表头，从2开始）
  - `field`（string）：固定为"数据重复"
  - `error`（string）：重复数据详细描述，包含序号、姓名、时间、项目信息
  - `existing_batch`（string）：已存在数据所属的导入批次号
- **存储限制**：支持存储无限制数量的重复数据记录（不限制数量）
- **序列化方法**：使用`json.dumps(repeats, ensure_ascii=False)`确保中文正确存储
- **解析方法**：后端优先使用`json.loads()`解析，失败则使用`ast.literal_eval()`兼容旧格式
- **用途**：
  - 记录所有导入时检测到的重复数据详细信息
  - 方便用户查看重复数据的位置和来源
  - existing_batch字段帮助追溯原始数据的导入批次
  - 支持用户根据重复数据决定是否采用覆盖策略
  - 历史记录永久保存，方便追溯

**重复数据判定规则：**

唯一性标识：`姓名 + 开始时间 + 项目名称`

**判定逻辑说明：**
- **同批次内**：允许同一个人在同一时间为同一项目提交多条工时记录（可能是不同的工作内容）
- **跨批次**：不同批次的导入中，同一个人在同一个时间为同一个项目提交的工时，判定为重复数据

当三个字段完全匹配且不属于同一导入批次时，判定为重复数据。

---

### 3.3 核对记录表（check_records）

#### 3.3.1 表结构

记录工时核对操作的执行历史和结果摘要。

```sql
CREATE TABLE check_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    check_no TEXT NOT NULL UNIQUE,                     -- 核对批次号，唯一
    check_type TEXT NOT NULL,                          -- 核对类型
    start_date DATE NOT NULL,                          -- 核对开始日期
    end_date DATE NOT NULL,                            -- 核对结束日期
    dept_name TEXT,                                    -- 核对部门（null表示全部门）
    user_name TEXT,                                    -- 核对人员（null表示全部人员）
    check_config TEXT NOT NULL,                        -- 核对规则配置（JSON）
    check_result TEXT NOT NULL,                        -- 核对结果摘要（JSON）
    check_user TEXT NOT NULL,                          -- 执行核对操作的用户
    check_time DATETIME NOT NULL DEFAULT (datetime('now', 'localtime')),
    report_path TEXT,                                  -- 核对报告文件路径
    created_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime'))
);

CREATE INDEX idx_check_records_check_no ON check_records(check_no);
CREATE INDEX idx_check_records_check_type ON check_records(check_type);
CREATE INDEX idx_check_records_check_time ON check_records(check_time);
CREATE INDEX idx_check_records_dept_user ON check_records(dept_name, user_name);
```

#### 3.3.2 字段详细说明

|字段名|类型|非空|默认值|索引|说明|
|---|---|---|---|---|---|
|id|INTEGER|是|自增|PK|主键|
|check_no|TEXT|是|-|UK|核对批次号，格式：CHK_YYYYMMDDHHMMSS_XXXX，全局唯一|
|check_type|TEXT|是|-|✅|核对类型：integrity（完整性）/ compliance（合规性）|
|start_date|DATE|是|-|-|核对开始日期，格式：YYYY-MM-DD|
|end_date|DATE|是|-|-|核对结束日期，格式：YYYY-MM-DD|
|dept_name|TEXT|否|-|✅|核对部门名称，null表示核对所有部门|
|user_name|TEXT|否|-|✅|核对人员姓名，null表示核对部门内所有人员|
|check_config|TEXT|是|-|-|核对规则配置，JSON格式，详见下文|
|check_result|TEXT|是|-|-|核对结果摘要，JSON格式，详见下文|
|check_user|TEXT|是|-|-|执行核对操作的用户名|
|check_time|DATETIME|是|now|✅|核对操作时间|
|report_path|TEXT|否|-|-|核对报告Excel文件的存储路径|
|created_at|DATETIME|是|now|-|记录创建时间|

#### 3.3.3 check_config JSON结构

**完整性检查配置：**
```json
{
  "type": "integrity",
  "workdays": [1, 2, 3, 4, 5],
  "exclude_holidays": false
}
```

**合规性检查配置：**
```json
{
  "type": "compliance",
  "standard_hours": 8,
  "min_hours": 4,
  "max_overtime": 4,
  "max_monthly_overtime": 80
}
```

#### 3.3.4 check_result JSON结构

**完整性检查结果：**
```json
{
  "type": "integrity",
  "total_users": 50,
  "missing_users": 3,
  "total_missing_days": 15,
  "integrity_rate": 99.5,
  "details": [
    {"dept_name": "研发部", "user_name": "张三", "missing_dates": "2026-01-10,2026-01-11", "missing_days": 2}
  ]
}
```

**合规性检查结果：**
```json
{
  "type": "compliance",
  "total_records": 1000,
  "abnormal_records": 15,
  "abnormal_users": 5,
  "compliance_rate": 98.5,
  "invalid_types": {
    "short_hours": 8,
    "excess_overtime": 5,
    "cumulative_excess": 2
  },
  "details": [
    {"dept_name": "研发部", "user_name": "张三", "date": "2026-01-15", "abnormal_type": "short_hours", "description": "工作时长3小时，低于下限4小时"}
  ]
}
```

---

### 3.4 系统用户表（sys_users）

#### 3.4.1 表结构

存储系统登录用户信息，支持账号锁定保护机制。

```sql
CREATE TABLE sys_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_name TEXT NOT NULL UNIQUE,                    -- 登录用户名，唯一
    password TEXT NOT NULL,                            -- 加密后的密码（bcrypt）
    real_name TEXT,                                    -- 用户真实姓名
    dept_name TEXT,                                    -- 用户所属部门
    role TEXT NOT NULL DEFAULT 'user',                 -- 用户角色：admin/user
    email TEXT,                                        -- 邮箱（可选，用于找回密码）
    status TEXT NOT NULL DEFAULT 'active',             -- 账号状态：active/locked
    login_fail_count INTEGER NOT NULL DEFAULT 0,       -- 登录失败次数
    lock_time DATETIME,                                -- 账号锁定时间
    last_login_time DATETIME,                          -- 最后登录成功时间
    last_login_ip TEXT,                                -- 最后登录IP
    created_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime')),
    updated_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime'))
);

CREATE INDEX idx_sys_users_user_name ON sys_users(user_name);
CREATE INDEX idx_sys_users_status ON sys_users(status);
```

#### 3.4.2 字段详细说明

|字段名|类型|非空|默认值|索引|说明|
|---|---|---|---|---|---|
|id|INTEGER|是|自增|PK|主键|
|user_name|TEXT|是|-|UK|登录用户名，全局唯一，建议使用邮箱或工号|
|password|TEXT|是|-|-|密码，使用bcrypt加密，不可逆|
|real_name|TEXT|否|-|-|用户真实姓名，用于显示|
|dept_name|TEXT|否|-|-|用户所属部门|
|role|TEXT|是|'user'|-|用户角色：admin（管理员）/ user（普通用户）|
|email|TEXT|否|-|-|邮箱地址，可选，用于密码找回等功能|
|status|TEXT|是|'active'|✅|账号状态：active（正常）/ locked（锁定）|
|login_fail_count|INTEGER|是|0|-|登录失败次数，超过5次锁定账号|
|lock_time|DATETIME|否|-|-|账号锁定时间，锁定30分钟后自动解锁|
|last_login_time|DATETIME|否|-|-|最后登录成功时间|
|last_login_ip|TEXT|否|-|-|最后登录IP地址|
|created_at|DATETIME|是|now|-|账号创建时间|
|updated_at|DATETIME|是|now|-|账号信息更新时间|

#### 3.4.3 账号锁定规则

```python
# 伪代码：账号锁定逻辑
MAX_LOGIN_FAILS = 5
LOCK_DURATION_MINUTES = 30

def check_login(username, password):
    user = db.get_user(username)

    # 检查账号是否锁定
    if user.status == 'locked':
        if datetime.now() - user.lock_time > timedelta(minutes=LOCK_DURATION_MINUTES):
            # 自动解锁
            user.status = 'active'
            user.login_fail_count = 0
            user.lock_time = None
        else:
            raise Exception('账号已锁定，请30分钟后再试')

    # 验证密码
    if bcrypt.verify(password, user.password):
        # 登录成功，重置失败次数
        user.login_fail_count = 0
        user.last_login_time = datetime.now()
        return True
    else:
        # 登录失败，增加失败次数
        user.login_fail_count += 1
        if user.login_fail_count >= MAX_LOGIN_FAILS:
            user.status = 'locked'
            user.lock_time = datetime.now()
        raise Exception('用户名或密码错误')
```

---

### 3.5 系统配置表（sys_config）

#### 3.5.1 表结构

存储系统级配置参数，支持运行时动态调整。

```sql
CREATE TABLE sys_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key TEXT NOT NULL UNIQUE,                   -- 配置键，唯一
    config_value TEXT NOT NULL,                        -- 配置值（JSON格式）
    config_type TEXT NOT NULL DEFAULT 'string',       -- 配置值类型：string/number/boolean/json
    category TEXT NOT NULL,                            -- 配置分类：import/check/system
    description TEXT,                                  -- 配置项说明
    is_editable INTEGER NOT NULL DEFAULT 1,           -- 是否可编辑：1-是/0-否
    created_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime')),
    updated_at DATETIME NOT NULL DEFAULT (datetime('now', 'localtime'))
);

CREATE INDEX idx_sys_config_config_key ON sys_config(config_key);
CREATE INDEX idx_sys_config_category ON sys_config(category);

-- 初始化默认配置数据
INSERT INTO sys_config (config_key, config_value, config_type, category, description, is_editable) VALUES
('import.max_file_size_mb', '10', 'number', 'import', 'Excel导入文件最大大小（MB）', 1),
('import.max_rows', '1000', 'number', 'import', '单次导入最大数据行数', 1),
('import.duplicate_strategy', 'skip', 'string', 'import', '默认重复数据处理策略：skip/overwrite', 1),
('check.integrity.workdays', '[1,2,3,4,5]', 'json', 'check', '完整性检查：工作日定义（1-7对应周一至周日）', 1),
('check.compliance.standard_hours', '8', 'number', 'check', '合规性检查：每日标准工作时长（小时）', 1),
('check.compliance.min_hours', '4', 'number', 'check', '合规性检查：每日工作时长下限（小时）', 1),
('check.compliance.max_overtime', '4', 'number', 'check', '合规性检查：每日加班时长上限（小时）', 1),
('check.compliance.max_monthly_overtime', '80', 'number', 'check', '合规性检查：每月加班时长上限（小时）', 1),
('system.max_login_fails', '5', 'number', 'system', '登录失败最大次数，超过则锁定账号', 1),
('system.lock_duration_minutes', '30', 'number', 'system', '账号锁定时长（分钟）', 1),
('system.session_timeout_hours', '8', 'number', 'system', '会话超时时间（小时）', 1),
('system.file_retention_days', '7', 'number', 'system', '临时文件保留天数', 1);
```

#### 3.5.2 字段详细说明

|字段名|类型|非空|默认值|索引|说明|
|---|---|---|---|---|---|
|id|INTEGER|是|自增|PK|主键|
|config_key|TEXT|是|-|UK|配置键，唯一标识，如：import.max_file_size_mb|
|config_value|TEXT|是|-|-|配置值，存储为文本，根据config_type解析|
|config_type|TEXT|是|'string'|-|配置值类型：string/number/boolean/json|
|category|TEXT|是|-|✅|配置分类：import（导入）/ check（核对）/ system（系统）|
|description|TEXT|否|-|-|配置项说明，用于管理界面展示|
|is_editable|INTEGER|是|1|-|是否可编辑：1-可编辑 / 0-只读|
|created_at|DATETIME|是|now|-|配置创建时间|
|updated_at|DATETIME|是|now|-|配置更新时间|

#### 3.5.3 配置项清单

|配置键|分类|类型|默认值|说明|
|---|---|---|---|---|
|import.max_file_size_mb|import|number|10|Excel导入文件最大大小（MB）|
|import.max_rows|import|number|1000|单次导入最大数据行数|
|import.duplicate_strategy|import|string|skip|默认重复数据处理策略：skip/overwrite|
|check.integrity.workdays|check|json|[1,2,3,4,5]|完整性检查：工作日定义|
|check.compliance.standard_hours|check|number|8|合规性检查：每日标准工作时长（小时）|
|check.compliance.min_hours|check|number|4|合规性检查：每日工作时长下限（小时）|
|check.compliance.max_overtime|check|number|4|合规性检查：每日加班时长上限（小时）|
|check.compliance.max_monthly_overtime|check|number|80|合规性检查：每月加班时长上限（小时）|
|system.max_login_fails|system|number|5|登录失败最大次数|
|system.lock_duration_minutes|system|number|30|账号锁定时长（分钟）|
|system.session_timeout_hours|system|number|8|会话超时时间（小时）|
|system.file_retention_days|system|number|7|临时文件保留天数|

---

## 四、ER关系图

```mermaid
erDiagram
    work_hour_data }o--|| import_records : "关联"
    work_hour_data }o--|| sys_users : "导入用户"
    check_records }o--|| sys_users : "核对用户"

    work_hour_data {
        INTEGER id PK
        TEXT serial_no
        TEXT user_name
        DATETIME start_time
        DATETIME end_time
        TEXT project_manager
        TEXT project_name
        REAL work_hours
        REAL overtime_hours
        TEXT dept_name
        TEXT import_batch_no FK
        DATETIME import_time
    }

    import_records {
        INTEGER id PK
        TEXT batch_no UK
        TEXT file_name
        INTEGER total_rows
        INTEGER success_rows
        INTEGER repeat_rows
        INTEGER invalid_rows
        TEXT import_user FK
        DATETIME import_time
        TEXT error_details
    }

    check_records {
        INTEGER id PK
        TEXT check_no UK
        TEXT check_type
        DATE start_date
        DATE end_date
        TEXT dept_name
        TEXT user_name
        TEXT check_config
        TEXT check_result
        TEXT check_user FK
        DATETIME check_time
    }

    sys_users {
        INTEGER id PK
        TEXT user_name UK
        TEXT password
        TEXT real_name
        TEXT dept_name
        TEXT role
        TEXT status
        INTEGER login_fail_count
        DATETIME lock_time
    }

    sys_config {
        INTEGER id PK
        TEXT config_key UK
        TEXT config_value
        TEXT config_type
        TEXT category
        TEXT description
        INTEGER is_editable
    }
```

---

## 五、SQL查询示例

### 5.1 工时查询相关

#### 5.1.1 项目维度查询

```sql
-- 查询指定项目名称和时间范围的工时数据
SELECT
    id,
    serial_no,
    user_name,
    start_time,
    end_time,
    project_manager,
    project_name,
    work_hours,
    overtime_hours,
    dept_name,
    work_content
FROM work_hour_data
WHERE project_name LIKE ?
  AND start_time >= ? AND start_time <= ?
ORDER BY start_time DESC
LIMIT ? OFFSET ?;

-- 汇总统计：按项目维度
SELECT
    project_name,
    project_manager,
    COUNT(*) as total_records,
    COUNT(DISTINCT user_name) as user_count,
    SUM(work_hours) as total_work_hours,
    SUM(overtime_hours) as total_overtime_hours
FROM work_hour_data
WHERE project_name LIKE ?
  AND start_time >= ? AND start_time <= ?
GROUP BY project_name, project_manager;
```

#### 5.1.2 组织维度查询

```sql
-- 查询指定部门和时间的工时数据
SELECT
    id,
    serial_no,
    user_name,
    start_time,
    end_time,
    project_manager,
    project_name,
    work_hours,
    overtime_hours,
    dept_name,
    work_content
FROM work_hour_data
WHERE dept_name = ?
  AND (? = '' OR user_name = ?)
  AND start_time >= ? AND start_time <= ?
ORDER BY start_time DESC
LIMIT ? OFFSET ?;

-- 汇总统计：按组织维度
SELECT
    dept_name,
    COUNT(*) as total_records,
    COUNT(DISTINCT user_name) as user_count,
    COUNT(DISTINCT project_name) as project_count,
    SUM(work_hours) as total_work_hours,
    SUM(overtime_hours) as total_overtime_hours
FROM work_hour_data
WHERE dept_name = ?
  AND (? = '' OR user_name = ?)
  AND start_time >= ? AND start_time <= ?
GROUP BY dept_name;
```

### 5.2 工时核对相关

#### 5.2.1 完整性检查

```sql
-- 步骤1：获取核对时间范围内所有应该提交工时的用户
SELECT DISTINCT user_name, dept_name
FROM work_hour_data
WHERE start_time >= ? AND start_time <= ?
  AND (? = '' OR dept_name = ?)
  AND (? = '' OR user_name = ?);

-- 步骤2：获取每个用户在每个工作日的工时记录数
SELECT
    user_name,
    dept_name,
    DATE(start_time) as work_date,
    COUNT(*) as record_count
FROM work_hour_data
WHERE start_time >= ? AND start_time <= ?
  AND (? = '' OR dept_name = ?)
  AND (? = '' OR user_name = ?)
GROUP BY user_name, dept_name, DATE(start_time)
ORDER BY user_name, work_date;

-- 步骤3：识别缺失日期（应用层计算）
-- 对比工作日历和实际提交记录，生成缺失报告
```

#### 5.2.2 合规性检查

```sql
-- 查询异常数据：工时过短
SELECT
    user_name,
    dept_name,
    DATE(start_time) as work_date,
    work_hours,
    overtime_hours,
    'short_hours' as abnormal_type,
    '工作时长' || work_hours || '小时，低于下限' || ? || '小时' as abnormal_desc
FROM work_hour_data
WHERE start_time >= ? AND start_time <= ?
  AND (? = '' OR dept_name = ?)
  AND (? = '' OR user_name = ?)
  AND work_hours < ?;

-- 查询异常数据：加班超标
SELECT
    user_name,
    dept_name,
    DATE(start_time) as work_date,
    work_hours,
    overtime_hours,
    'excess_overtime' as abnormal_type,
    '加班时长' || overtime_hours || '小时，超过上限' || ? || '小时' as abnormal_desc
FROM work_hour_data
WHERE start_time >= ? AND start_time <= ?
  AND (? = '' OR dept_name = ?)
  AND (? = '' OR user_name = ?)
  AND overtime_hours > ?;

-- 查询异常数据：月度累计超标（分组聚合）
SELECT
    user_name,
    dept_name,
    strftime('%Y-%m', start_time) as month,
    SUM(overtime_hours) as total_overtime,
    'cumulative_excess' as abnormal_type,
    '月度累计加班' || SUM(overtime_hours) || '小时，超过上限' || ? || '小时' as abnormal_desc
FROM work_hour_data
WHERE start_time >= ? AND start_time <= ?
  AND (? = '' OR dept_name = ?)
  AND (? = '' OR user_name = ?)
GROUP BY user_name, dept_name, strftime('%Y-%m', start_time)
HAVING SUM(overtime_hours) > ?;
```

### 5.3 数据导入相关

#### 5.3.1 唯一性校验

```sql
-- 检查数据是否重复
SELECT COUNT(*) as count
FROM work_hour_data
WHERE serial_no = ?
  AND user_name = ?
  AND start_time = ?
  AND project_name = ?;
```

#### 5.3.2 批量导入（事务处理）

```sql
BEGIN TRANSACTION;

-- 插入导入记录
INSERT INTO import_records (
    batch_no, file_name, file_size, total_rows, success_rows, repeat_rows,
    invalid_rows, duplicate_strategy, import_user, import_time
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now', 'localtime'));

-- 批量插入工时数据（参数化查询，循环执行）
INSERT INTO work_hour_data (
    serial_no, user_name, start_time, end_time, project_manager, project_name,
    work_hours, overtime_hours, work_content, create_time, current_leader,
    approval_result, approval_status, update_time, dept_name, import_batch_no,
    import_time
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now', 'localtime'));

COMMIT;
```

### 5.4 导入记录查询

```sql
-- 查询导入记录列表（支持分页和筛选）
SELECT
    id,
    batch_no,
    file_name,
    total_rows,
    success_rows,
    repeat_rows,
    invalid_rows,
    import_user,
    import_time
FROM import_records
WHERE (? = '' OR file_name LIKE ?)
  AND (? = '' OR import_time >= ?)
  AND (? = '' OR import_time <= ?)
ORDER BY import_time DESC
LIMIT ? OFFSET ?;

-- 统计导入记录总数
SELECT COUNT(*) as total
FROM import_records
WHERE (? = '' OR file_name LIKE ?)
  AND (? = '' OR import_time >= ?)
  AND (? = '' OR import_time <= ?);
```

### 5.5 按批次查看导入数据

```sql
-- 查询指定批次的工时数据
SELECT
    id,
    serial_no,
    user_name,
    start_time,
    end_time,
    project_manager,
    project_name,
    work_hours,
    overtime_hours,
    dept_name,
    work_content
FROM work_hour_data
WHERE import_batch_no = ?
ORDER BY start_time DESC
LIMIT ? OFFSET ?;

-- 统计批次数据汇总
SELECT
    COUNT(*) as total_records,
    SUM(work_hours) as total_work_hours,
    SUM(overtime_hours) as total_overtime_hours,
    COUNT(DISTINCT user_name) as user_count,
    COUNT(DISTINCT project_name) as project_count
FROM work_hour_data
WHERE import_batch_no = ?;
```

---

## 六、数据库维护

### 6.1 初始化脚本

```sql
-- database_init.sql
-- 项目工时统计系统数据库初始化脚本

-- 创建表
CREATE TABLE IF NOT EXISTS work_hour_data (...);
CREATE TABLE IF NOT EXISTS import_records (...);
CREATE TABLE IF NOT EXISTS check_records (...);
CREATE TABLE IF NOT EXISTS sys_users (...);
CREATE TABLE IF NOT EXISTS sys_config (...);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_work_hour_data_start_time ON work_hour_data(start_time);
CREATE INDEX IF NOT EXISTS idx_work_hour_data_user_name ON work_hour_data(user_name);
CREATE INDEX IF NOT EXISTS idx_work_hour_data_dept_name ON work_hour_data(dept_name);
CREATE INDEX IF NOT EXISTS idx_work_hour_data_project_name ON work_hour_data(project_name);
CREATE INDEX IF NOT EXISTS idx_work_hour_data_import_batch_no ON work_hour_data(import_batch_no);
CREATE INDEX IF NOT EXISTS idx_work_hour_data_composite ON work_hour_data(user_name, start_time, project_name);

-- 初始化系统配置
INSERT OR REPLACE INTO sys_config (config_key, config_value, config_type, category, description, is_editable) VALUES
('import.max_file_size_mb', '10', 'number', 'import', 'Excel导入文件最大大小（MB）', 1),
('import.max_rows', '1000', 'number', 'import', '单次导入最大数据行数', 1),
-- ... 其他配置项

-- 初始化管理员账号（密码：admin123，需在应用层修改）
INSERT OR IGNORE INTO sys_users (user_name, password, real_name, role, status)
VALUES ('admin', '$2b$12$XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX', '系统管理员', 'admin', 'active');
```

### 6.2 备份与恢复

#### 备份脚本

```bash
# 使用SQLite的备份命令
sqlite3 workinghour.db ".backup workinghour_backup_$(date +%Y%m%d_%H%M%S).db"

# 或使用导出SQL方式
sqlite3 workinghour.db .dump > workinghour_backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 恢复脚本

```bash
# 从备份文件恢复
sqlite3 workinghour.db ".restore workinghour_backup_20260115_100000.db"

# 或从SQL文件恢复
sqlite3 workinghour.db < workinghour_backup_20260115_100000.sql
```

### 6.3 性能优化建议

1. **定期VACUUM**：回收删除数据占用的空间
```sql
VACUUM;
```

2. **ANALYZE**：更新统计信息，优化查询计划
```sql
ANALYZE;
```

3. **索引维护**：定期检查索引使用情况，删除未使用的索引
```sql
-- 查看索引统计信息（需要SQLite扩展）
PRAGMA index_info('idx_work_hour_data_start_time');
```

4. **查询优化**：使用EXPLAIN QUERY PLAN分析慢查询
```sql
EXPLAIN QUERY PLAN
SELECT * FROM work_hour_data WHERE dept_name = '研发部' AND start_time >= '2026-01-01';
```

---

## 七、数据字典

### 7.1 表级别字典

|表名|中文名|记录数预估|增长频率|重要性|
|---|---|---|---|---|
|work_hour_data|工时数据主表|10万+/月|高频增长|核心|
|import_records|导入批次记录表|1千/月|中频增长|重要|
|check_records|核对批次记录表|1千/月|中频增长|重要|
|sys_users|系统用户表|50|低频增长|核心|
|sys_config|系统配置表|20|静态|辅助|

### 7.2 字段级别字典（按表）

详见各表的字段详细说明章节。

---

## 八、附录

### 8.1 SQLite版本要求

- 最低版本：SQLite 3.35.0+
- 推荐版本：SQLite 3.41.0+
- 支持特性：
  - GENERATED ALWAYS columns（暂未使用）
  - UPSERT（INSERT OR REPLACE）
  - Window functions（可用于复杂统计）

### 8.2 数据迁移路径

当前设计支持低成本迁移至MySQL：

|SQLite|MySQL|
|---|---|
|INTEGER PRIMARY KEY AUTOINCREMENT|INT AUTO_INCREMENT PRIMARY KEY|
|TEXT|VARCHAR或TEXT|
|REAL|DOUBLE或DECIMAL|
|DATETIME|DATETIME|
|UNIQUE约束|UNIQUE KEY|

### 8.3 版本变更记录

|版本号|变更时间|变更内容|变更人|
|---|---|---|---|
|V1.0.0|2026-01-15|初始数据库设计，包含5个核心表和完整索引|全栈软件开发工程师|

---

**文档生成时间：** 2026-01-15
**关联文档：** 架构设计说明书 V1.2.0、需求规格书 V1.1.0、API接口设计文档 V1.0.0
